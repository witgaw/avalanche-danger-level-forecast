\documentclass{article}
\usepackage[toc,page]{appendix}

\usepackage[preprint]{neurips_2023}
\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage[T1]{fontenc}    % use 8-bit T1 fonts
\usepackage{hyperref}       % hyperlinks
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
\usepackage{xcolor}         % colors
\usepackage{hyperref}       % links

\usepackage{graphicx}       % include graphics
\usepackage{float}
\usepackage[T1]{fontenc}

\usepackage{caption}
\usepackage{subcaption}

\usepackage{multirow}

\newcommand{\sais}{Scottish Avalanche Information Service}
\newcommand{\usfs}{US Forest Service National Avalanche Center}

\title{ML-based avalanche danger level forecasting. \\ Category: General Machine Learning}


\author{
  Witold Gawlikowicz (06932552) \\
  \texttt{witold@stanford.edu}
}


\begin{document}

\maketitle

\graphicspath{{assets/figures/}}


% \begin{abstract}
% \end{abstract}

% TODOs:
	% Go into details of what the snowpack data is

	% Milestone
	% The milestone will help you make sure you're on track, and should describe what you've accomplished so far, and very briefly say what else you plan to do. You should write it as if it's an “early draft" of what will turn into your final project. You can write it as if you're writing the first few pages of your final project report, so that you can re-use most of the milestone text in your final report. Please write the milestone (and final report) keeping in mind that the intended audience are the instructors and the TAs. Thus, for example, you should not spend two pages explaining what logistic regression is. Your milestone should include the full names of all your team members and state the full title of your project. Note: We will expect your final writeup to be on the same topic as your milestone.
	% Contributions
	% Please include a section that describes what each team member worked on and contributed to the project. This is to make sure team members are carrying a fair share of the work for projects. If you have any concerns working with one of your project teammates, please create a private Ed post.
	% Grading
	% The milestone is mostly intended to get feedback from TAs to make sure you’re making reasonable progress. As long as your milestone follows the instructions above and you seem to have tested any assumptions which might prevent your team from completing the project, you should do well on the milestone.
	% Format
	% Your milestone should be at most 3 pages, excluding references. Similar to the proposal, it should include
	% Motivation: What problem are you tackling, and what's the setting you're considering?
	% Method: What machine learning techniques have you tried and why?
	% Preliminary experiments: Describe the experiments that you've run, the outcomes, and any error analysis that you've done. You should have tried at least one baseline.
	% Next steps: Given your preliminary results, what are the next steps that you're considering?
	
	

% \section*{Acknowledgements}

\section{Introduction}

	Every year around a 100 people loose their lives to avalanches \href{https://www.avalanches.org/fatalities/}{in Europe alone} despite the fact that avalanche danger level forecasts are widely available there. There are many mountainous regions around the world for which no such forecasts are published, therefore automating the process of avalanche forecast generation could have real impact on lives of many people around the world. \\

	The main part of the avalanche danger level forecast for a given region is the overall avalanche danger level. It's expressed on a 5 point scale ranging from 1 (lowest) to 5 (highest).	\href{https://www.shastaavalanche.org/page/how-read-advisory}{Forecasts} for many regions often also contain: \href{https://avalanche.state.co.us/forecasts/tutorial/avalanche-problems}{the avalanche problems} (main characteristics of the snowpack which contribute to its instability and hence potential avalanche) and the aspect-elevation rose which shows more fine-grained avalanche danger levels broken down by slope's aspect and elevation. \\
	The primary goal of this project is to use the overall avalanche danger level forecast for the region as the dependent variable, however time- and data-permitting we would also like to explore the possibility generating those more detailed elements of an avalanche forecast.	
	
\section{Data}

	% This section briefly describes the datasets collected to date.

\subsection{\sais}\label{sec:data_sais}

	The \href{https://www.sais.gov.uk/forecast-archive/}{Scottish Avalanche Information Service} (SAIS) provides historical avalanche forecasts for 6 regions in Scotland. The forecasts are typically published from December to April. SAIS allows bulk download of snowprofile data containing avalanche hazard level as well as snowprofile data collected during compilation of observed hazard levels. The size of the dataset prior to any cleansing was \input{assets/snippets/sais_size_initial.txt}observations.
	\newline
	The dataset contains two variables either of which could be used as our dependent variable: observed and forecasted avalanche hazard level.
	The forecasted value is decided on by avalanche professionals working in a given area based on the current state of the snowpack and the weather forecast for the next day.
	The observed value (nowcast) is updated on the day.
	\newline
	While both values are compiled using a standardised methodology, there is an inherent subjectivity in both of them, but especially so in the nowcast as it relies a lot on travel throughout the area and multifaceted, in-person assessment of the snow conditions. For that reason we will use the forecasted value as our dependent value as it should be more standardised, have a clearer relationship with the weather inputs, and thus be more feasible for the model to discover the underlying relationship between the variables.

\subsubsection{Initial transformation}
	We have dropped missing values of both potential independent variables and used various strategies for filling missing data (details can be found if Table \ref{tbl:sais_replacements_log}). Brining the number of observations down to \input{assets/snippets/sais_size_final.txt}\unskip.
\subsubsection{Splits}
	As seen in Table \ref{tbl:sais_area_breakdown} the "Torridon" region only has relevant observations present present from the 2013/2014 winter season (as opposed to the other ones for which relevant observations are present from 2007/2008 season onwards). 
	Because of that the region has fewest observations and might have different characterstics due to changes in methodology and climate over time. For that reason we have decided to use it as a test set to see how well the models generalise into other regions (and to some extent different time frames).
	While it would be nice to be able to test how well models generalise to other time frames for the data from the same regions as they were trained on we have decided not to withold any data for that purpose not to reduce the size of the remaining datasetset any further. This data will start appearing for the 2024/2025 winter season soon, so we will extend the dataset with that test set when available.
	\newline
	We have used 20\% of the remaining data as the development set stratifying on both the areas and avalanche hazard levels. The resulting split is presented in the table below:
	\input{assets/tables/sais_hazard_breakdown_per_split.tex}
	Breakdown of hazard levels per each area in Training and Development sets can be found in Tables \ref{tbl:sais_mapped_hazard_breakdown_per_area_train} and \ref{tbl:sais_mapped_hazard_breakdown_per_area_dev}

\subsection{\usfs}
	The \usfs dataset contains \input{assets/snippets/usfs_size_final.txt}observations after cleansing. However, these do not contain any weather or snowprofile data, hence these will be considered in a later part of the project if suitable weather data is available.
	Table \ref{tbl:usfs_hazard_breakdown_per_area} in the Appendix contains breakdown of danger hazard levels by areas (represented with codes) 

\section{Metrics}

	To begin with we will consider accuracy, precision, recall and $F_1$ score as the primary metrics for evaluating the model. Precision, recall and $F_1$ score will be computed per-class, as well as micro- and macro-averaged
	\newline
	We have also included the mean squared errors computed on mapped classes (integers from 1 to 4), average error ($y^{true} - y^{predicted}$) and "highest error" which computes the maximum absolute error, but preserves the sign. The last two metrics are constructed to give basic understanding of model's under- or over-reporting of the hazard level.

\subsection{Baseline fits}

	To get a better feel for how the different metrics are behaving on this dataset we will compute two baselines: 
	\begin{enumerate}
		\item A constant model that always predicts the most common class in the training set.
		\item "Observed" model returning the observed avalanche hazard level discussed in Section \ref{sec:data_sais}.
	\end{enumerate}
	The idea is that the first baseline will provide a lower bound on the performance of any model we might want to begin to consider and the second one will likely be the upper bound as it's compiled by the same experts who made the forecast, but with the additional benefit of being able to directly observe the actual changes in the snowpack.

	Metrics for those baselines and all the models considered will be included in Section \ref{sec:evaluation}.

\section{Model Fitting}

	In this section, we describe the process of fitting machine learning models to the collected data. We start with a simple softmax regression model as a point of reference for more complex models.

\subsection{Softmax Regression}

	Softmax regression, also known as multinomial logistic regression, is a generalization of logistic regression to multiple classes. It is a simple and interpretable model that serves as a good starting point.
	We have run it with the default settings in the \texttt{scikit-learn} library, therefore there is potentially still some room to improve the fit. This will be explored in the later part of the project.

\section{Evaluation}\label{sec:evaluation}
	The evaluation metrics for each model computed on the test set are presented below. Please refer to the appendix for equivalent tables for the development and training (for quality of fit assesment purposes, not to make any statements about how the models generalise) sets.
	\input{assets/tables/sais_eval_test.tex}

\section{Next steps}
	Please note that some of these are nice to haves, I very likely will not manage to go though all of them in the time available (though I am keen to continue working on this problem beyond this term):
	\begin{itemize}
		\item Expolre performance of more complex models on SAIS dataset. 
		\item Apply approach from \cite{nhess-22-2031-2022} to available datasets.
		\item Look into APIs for historical weather data.
		\item If historical data is available revisit SAIS dataset and train it on: mixture of existing snowprofiles and weather data, weather data only, and \href{https://snowpack.slf.ch}{simulated snow profiles}.
		\item If the above shows promise re-run it on US Forrest Service dataset.
		\item See if it's possible to use data relating to observations of snowpack at different locations within each area to add more granularity to the model (still predict overall hazard level for a forecast area, but see if it can be locally raised or lowered depening on aspects, elevations, angles and altitudes).
		\item Visualise predictions on a map.
	\end{itemize}

\newpage
\begin{appendices}
	\section{Dataset details}
	This section contains further details of the datasets used for the project.
	\subsection{\sais}
	\input{assets/tables/sais_summary_initial.tex}
	\begin{figure}[h]
		\centering
		\includegraphics[width=0.7\textwidth]{sais_observation_histogram.png}
		\caption{Histogram of avalanche danger levels in the SAIS dataset.}
		\label{fig:sais_observation_histogram}
	\end{figure}

	\input{assets/tables/sais_area_breakdown.tex}
	\input{assets/tables/sais_hazard_breakdown_per_area.tex}
	\input{assets/tables/sais_mapped_hazard_breakdown_per_area.tex}
	\input{assets/tables/sais_replacements_log.tex}
	\input{assets/tables/sais_mapped_hazard_breakdown_per_area_train.tex}
	\input{assets/tables/sais_mapped_hazard_breakdown_per_area_dev.tex}

	\subsection{\usfs}

	\input{assets/tables/usfs_hazard_breakdown_per_area.tex}
	\newpage
	\section{Evaluation}
	\begin{figure}[h]
		\centering
		\begin{subfigure}[t]{0.49\textwidth}
			\centering
			\includegraphics[width=\textwidth]{sais_confusion_matrix_constant_test.png}
			\caption{Test set}
		\end{subfigure}
		\hfil
		\begin{subfigure}[t]{0.49\textwidth}
			\centering
			\includegraphics[width=\textwidth]{sais_confusion_matrix_constant_development.png}
			\caption{Development set}
		\end{subfigure}
		\caption{Constant model}
	\end{figure}

	\begin{figure}[h]
		\centering
		\begin{subfigure}[t]{0.49\textwidth}
			\centering
			\includegraphics[width=\textwidth]{sais_confusion_matrix_observed_test.png}
			\caption{Test set}
		\end{subfigure}
		\hfil
		\begin{subfigure}[t]{0.49\textwidth}
			\centering
			\includegraphics[width=\textwidth]{sais_confusion_matrix_observed_development.png}
			\caption{Development set}
		\end{subfigure}
		\caption{"Observed" model}
	\end{figure}

	\begin{figure}[h]
		\centering
		\begin{subfigure}[t]{0.49\textwidth}
			\centering
			\includegraphics[width=\textwidth]{sais_confusion_matrix_softmax_regression_test.png}
			\caption{Test set}
		\end{subfigure}
		\hfil
		\begin{subfigure}[t]{0.49\textwidth}
			\centering
			\includegraphics[width=\textwidth]{sais_confusion_matrix_softmax_regression_development.png}
			\caption{Development set}
		\end{subfigure}
		\caption{Softmax regression model}
	\end{figure}


	

\end{appendices}
	
\newpage
\bibliography{references}
\bibliographystyle{plainnat}

\end{document}

	% Leftovers:
	%	As the number of people participating in outdoor recreation is \href{https://americancanoe.org/wp-content/uploads/2023/06/2023_Outdoor_Participation_Trends_Report.pdf}{steadily growing in the US}, and likely most of the other countries with access to mountains too, a
	%	On a \href{https://avalanche.org/avalanche-encyclopedia/human/resources/north-american-public-avalanche-danger-scale/}{North American scale} the levels are: 1 - "low", 2 - "moderate", 3 - "considerable", 4 - "high", 5 - "extreme". 
	%	The \href{https://www.avalanches.org/standards/avalanche-danger-scale/}{European scale} is similar with level 5 being described as "very high". Due to the ongoing efforts of the global avalanche forecasting scientific community the forecasting terminology have been getting more standardised across the world. However, it has to be noted that regional difference may still be present. 
	%	aspect ("N", "NE", "E", "SE", "S", "SW", "W", "NW") and elevation (either absolute elevations applicable to a given region or relative elevations driven by tree cover: "below treeline", "near treeline", "above treeline").
